global.CONNS=CONNS=OBJECT({init:function(t,o,e){"use strict";var a,r,i,n=t.socketPack,d={};e.addRoomFunc=a=function(t,o){void 0===d[t]&&(d[t]=[]),d[t].push(o)},n.on("connection",function(t){var o,e=t.handshake.headers["x-forwarded-for"],a={},r={},i={},n={};void 0===e&&(e=t.handshake.address.address),t.addListener("disconnect",function(){EACH(n,function(t){EACH(t,function(t){t()})})}),t.addListener("__ENTER_ROOM",function(c){EACH(d,function(d,v){var s,u="",f=v,E={};return s=function(t){var o,e;return-1!==f.indexOf("{")&&-1!==f.indexOf("}")&&(e=f.substring(0,f.indexOf("{")),u+"/"===e)?(o=f.substring(f.indexOf("{")+1,f.indexOf("}")),f=e+t+f.substring(f.indexOf("}")+1),{name:o,value:t}):void 0},EACH(c.split("/"),function(t,o){var e=s(t);return void 0!==e&&(E[e.name]=e.value),0===o?u=t:u+="/"+t,u===f?!1:void 0}),c===f?(void 0===r[c]?(a[c]=[],n[c]=[],t.join(c),EACH(d,function(r){a[c].push(r(c,t,e,t.handshake.headers,E,function(t){o=t},function(){return o},function(){o=void 0},i,n[c]))}),r[c]=1):r[c]+=1,!1):void 0})}),t.addListener("__EXIT_ROOM",function(o){r[o]-=1,0===r[o]&&(EACH(a[o],function(t){t.removeAllListeners()}),t.leave(o),delete a[o],delete r[o],delete n[o])})}),e.emitToAllSockets=r=function(t){var o=t.ns,e=t.listenerName,a=t.data;CONNS.type.socketPack["in"](o).emit(e,a)},e.emitToAllWorkers=i=function(o){r(o),t.broadcastToAllWorkers({methodName:"emitToAllSockets",data:o})}}}),FOR_BOX(function(t){"use strict";t.DB=CLASS({init:function(o,e,a,r){var i,n,d,c,v,s,u,f,E,m,D,h,l,S,R,O,A,_=UPPERCASE.IO.MODULE("mongolian").ObjectId;SERVER_CONFIG.isNotUsingDB===!0?(a.createData=m=function(){},a.getData=D=function(){},a.updateData=h=function(){},a.removeData=l=function(){},a.findData=S=function(){},a.findDataSet=R=function(){},a.countDataSet=O=function(){},a.checkIsExists=A=function(){}):(i=UPPERCASE.IO.db.collection(t.boxName+"."+r),n=UPPERCASE.IO.db.collection(t.boxName+"."+r+"__BACKUP"),d=UPPERCASE.IO.db.collection(t.boxName+"."+r+"__ERROR"),c=function(t){return new _(t)},v=function(t){return void 0!==t._id&&(t.id=t._id.toString()),delete t._id,delete t.__IS_ENABLED,delete t.__RANDOM_KEY,t},s=function(t){EACH(t,function(o,e){o===TO_DELETE?REMOVE_AT({data:t,key:e}):(CHECK_IS_DATA(o)===!0||CHECK_IS_ARRAY(o)===!0)&&s(o)})},u=function(t){void 0!==t.id&&(CHECK_IS_DATA(t.id)===!0?(EACH(t.id,function(o,e){CHECK_IS_DATA(o)===!0||CHECK_IS_ARRAY(o)===!0?EACH(o,function(t,e){o[e]=c(t)}):t.id[e]=c(o)}),t._id=t.id):t._id=c(id),delete t.id),t.__IS_ENABLED=!0,EACH(t,function(o,e){void 0===o&&delete t[e]})},f=function(t){var o=t.method,e=t.data,a=new Date,r={method:o,time:a,data:e};n.save(r),SERVER_CONFIG.isDBLogMode===!0&&console.log("[DB SAVED]",r)},E=function(t){t.time=new Date,d.save(t),SERVER_CONFIG.isDBLogMode===!0&&console.log("[DB ERROR]",t)},a.createData=m=function(t,o){var e;try{t.__IS_ENABLED=!0,t.__RANDOM_KEY=Math.random(),t.createTime=new Date,s(t),i.save(t,function(a,r){null===a?(f({method:"createData",data:r}),v(r),void 0!==o&&o(void 0,r)):(e=a.toString(),E({method:"createData",data:t,errorMsg:e}),void 0!==o&&o(e))})}catch(a){e=a.toString(),E({method:"createData",data:t,errorMsg:e}),void 0!==o&&o(e)}},a.getData=D=function(t,o){var e,a;try{e={_id:c(t),__IS_ENABLED:!0},i.findOne(e,function(e,r){null===e?(void 0!==r&&v(r),o(void 0,r)):(a=e.toString(),E({method:"getData",id:t,errorMsg:a}),o(a))})}catch(r){a=r.toString(),E({method:"getData",id:t,errorMsg:a}),o(a)}},a.updateData=h=function(t,o){var e,a,r=t.id;try{e={_id:c(r),__IS_ENABLED:!0},i.findOne(e,function(e,r){delete t.id,null===e?void 0===r?void 0!==o&&o():(EACH(r,function(o,e){(void 0===t[e]||"_id"===e||"__IS_ENABLED"===e||"createTime"===e)&&(t[e]=o)}),s(t),t.lastUpdateTime=new Date,i.save(t,function(e,r){null===e?(f({method:"updateData",data:r}),v(r),void 0!==o&&o(void 0,r)):(a=e.toString(),E({method:"updateData",data:t,errorMsg:a}),void 0!==o&&o(a))})):(a=e.toString(),E({method:"updateData",data:t,errorMsg:a}),void 0!==o&&o(a))})}catch(n){a=n.toString(),E({method:"updateData",data:t,errorMsg:a}),void 0!==o&&o(a)}},a.removeData=l=function(t,o){var e,a;try{e={_id:c(t),__IS_ENABLED:!0},i.findOne(e,function(e,r){null===e?void 0===r?void 0!==o&&o():(r.__IS_ENABLED=!1,r.removeTime=new Date,i.save(r,function(e,r){null===e?(f({method:"removeData",data:r}),v(r),void 0!==o&&o(void 0,r)):(a=e.toString(),E({method:"removeData",id:t,errorMsg:a}),void 0!==o&&o(a))})):(a=e.toString(),E({method:"removeData",id:t,errorMsg:a}),void 0!==o&&o(a))})}catch(r){a=r.toString(),E({method:"removeData",id:t,errorMsg:a}),void 0!==o&&o(a)}},a.findData=S=function(t,o){var e;void 0!==t&&void 0===o&&(o=t),void 0===t&&(t={});try{u(t),i.findOne(t,function(a,r){null===a?(void 0!==r&&v(r),o(void 0,r)):(e=a.toString(),E({method:"findData",filter:t,errorMsg:e}),o(e))})}catch(a){e=a.toString(),E({method:"findData",filter:t,errorMsg:e}),o(e)}},a.findDataSet=R=function(t,o){var e,a,r=void 0===t?void 0:t.filter,n=void 0===t?void 0:t.sort,d=void 0===t?void 0:t.start,c=void 0===t||void 0===t.count?void 0:INTEGER(t.count),s=void 0===t||void 0===t.isFindAll?void 0:INTEGER(t.isFindAll);void 0!==t&&void 0===o&&(o=t);try{void 0===r&&(r={}),void 0===n&&(n={}),void 0===d&&(d=0),s!==!0&&(void 0===c||c>SERVER_CONFIG.maxDataCount||isNaN(c)===!0?c=SERVER_CONFIG.maxDataCount:1>c&&(c=1)),u(r),a=function(a,r){null===a?(void 0!==r&&EACH(r,function(t){v(t)}),o(void 0,r)):(e=a.toString(),E({method:"findDataSet",params:t,errorMsg:e}),o(e))},s===!0?i.find(r).sort(n).skip(d).toArray(a):i.find(r).sort(n).skip(d).limit(c).toArray(a)}catch(f){e=f.toString(),E({method:"findDataSet",params:t,errorMsg:e}),o(e)}},a.countDataSet=O=function(t,o){var e;void 0!==t&&void 0===o&&(o=t),void 0===t&&(t={});try{u(t),i.find(t).count(function(a,r){null===a?o(void 0,r):(e=a.toString(),E({method:"countDataSet",filter:t,errorMsg:e}),o(e))})}catch(a){e=a.toString(),E({method:"countDataSet",filter:t,errorMsg:e}),o(e)}},a.checkIsExists=A=function(t,o){var e;void 0!==t&&void 0===o&&(o=t),void 0===t&&(t={});try{u(t),i.find(t).count(function(a,r){null===a?o(void 0,void 0!==r&&r>0):(e=a.toString(),E({method:"checkIsExists",filter:t,errorMsg:e}),o(e))})}catch(a){e=a.toString(),E({method:"checkIsExists",filter:t,errorMsg:e}),o(e)}})}})}),FOR_BOX(function(t){"use strict";t.LOG_DB=CLASS({init:function(o,e,a,r){var i,n;SERVER_CONFIG.isNotUsingDB===!0?a.log=n=function(){}:(i=UPPERCASE.IO.db.collection(t.boxName+"."+r),a.log=n=function(t){t.time=new Date,i.save(t)})}})}),FOR_BOX(function(t){"use strict";OVERRIDE(t.MODEL,function(){t.MODEL=CLASS({init:function(o,e,a,r){var i,n,d,c,v,s,u,f,E,m,D,h,l,S,R,O,A,_,C,g,N,M,b=r.name,p=void 0===r.propertyNamesForNewEvent?[]:r.propertyNamesForNewEvent,I=r.config,k=t.DB(b);void 0!==I&&(i=I.create,n=I.getData,d=I.update,c=I.remove,v=I.findData,s=I.findDataSet,u=I.countDataSet,f=I.checkIsExists,void 0!==i&&(E=i.valid),void 0!==d&&(m=d.valid)),e.getCreateValid=D=function(){return E},e.getUpdateValid=h=function(){return m},t.ROOM(b+"/create"),EACH(p,function(o){t.ROOM(b+"/"+o+"/{value}/create")}),t.ROOM(b+"/remove"),EACH(p,function(o){t.ROOM(b+"/"+o+"/{value}/remove")}),t.ROOM(b,function(o){i!==!1&&o.on("create",function(a,r){var i,n=void 0===E?void 0:E.check({data:a});void 0!==n&&n.checkHasError()===!0?r({hasError:!0,errors:n.getErrors()}):(i=function(){k.createData(a,function(a,i){void 0!==a?r({hasError:!0,errorMsg:a}):(void 0!==e.afterCreate&&e.afterCreate(i),void 0!==e.afterCreateRoom&&e.afterCreateRoom({savedData:i,room:o}),t.ROOMS(b+"/create").broadcast({methodName:"create",data:i}),EACH(p,function(o){var e=i[o];t.ROOMS(b+"/"+o+"/"+e+"/create").broadcast({methodName:"create",data:i})}),r({hasError:!1,savedData:i}))})},void 0===e.beforeCreateRoom?void 0!==e.beforeCreate?e.beforeCreate(a,{ret:r,proc:i})!==!1&&i():i():e.beforeCreateRoom({data:a,room:o},{ret:r,proc:i}))}),n!==!1&&o.on("getData",R),v!==!1&&o.on("findData",_),s!==!1&&o.on("findDataSet",function(t,o){delete t.isFindAll,C(t,o)}),u!==!1&&o.on("countDataSet",g),f!==!1&&o.on("checkIsExists",N)}),t.ROOM(b+"/{id}",function(o,a){var r=a.id;d!==!1&&o.on("update",function(t,a){var i,n=void 0===m?void 0:m.check({data:t,isExceptUndefined:!0});t.id=r,void 0!==n&&n.checkHasError()===!0?a({hasError:!0,errors:n.getErrors()}):(i=function(){k.updateData(t,function(t,r){void 0!==t?a({hasError:!0,errorMsg:t}):(void 0!==r&&(void 0!==e.afterUpdate&&e.afterUpdate(r),void 0!==e.afterUpdateRoom&&e.afterUpdateRoom({savedData:r,room:o}),o.broadcast({methodName:"update",data:r})),a({hasError:!1,savedData:r}))})},void 0===e.beforeUpdateRoom?void 0!==e.beforeUpdate?e.beforeUpdate(t,{ret:a,proc:i})!==!1&&i():i():e.beforeUpdateRoom({data:t,room:o},{ret:a,proc:i})!==!1&&i())}),c!==!1&&o.on("remove",function(a,r){var i;i=function(){k.removeData(a,function(a,i){void 0!==a?r({hasError:!0,errorMsg:a}):(void 0!==i&&(void 0!==e.afterRemove&&e.afterRemove(i),void 0!==e.afterRemoveRoom&&e.afterRemoveRoom({savedData:i,room:o}),o.broadcast({methodName:"remove",data:i}),EACH(p,function(o){var e=i[o];t.ROOMS(b+"/"+o+"/"+e+"/remove").broadcast({methodName:"remove",data:i})})),r({hasError:!1,savedData:i}))})},void 0===e.beforeRemoveRoom?void 0!==e.beforeRemove?e.beforeRemove(a,{ret:r,proc:i})!==!1&&i():i():e.beforeRemoveRoom({id:a,room:o},{ret:r,proc:i})!==!1&&i()})}),e.getDB=l=function(){return k},i!==!1&&(a.create=S=function(o,a){var r,i=void 0===E?void 0:E.check({data:o});void 0!==i&&i.checkHasError()===!0?void 0!==a&&a({hasError:!0,errors:i.getErrors()}):(r=function(){k.createData(o,function(o,r){void 0!==o?void 0!==a&&a({hasError:!0,errorMsg:o}):(void 0!==e.afterCreate&&e.afterCreate(r),t.ROOMS(b+"/create").broadcast({methodName:"create",data:r}),EACH(p,function(o){var e=r[o];t.ROOMS(b+"/"+o+"/"+e+"/create").broadcast({methodName:"create",data:r})}),void 0!==a&&a({hasError:!1,savedData:r}))})},void 0!==e.beforeCreate?e.beforeCreate(o,{ret:a,proc:r})!==!1&&r():r())}),n!==!1&&(a.getData=R=function(t,o){k.getData(t,function(t,a){void 0!==t?void 0!==o&&o({hasError:!0,errorMsg:t}):(void 0===e.getData||e.getData(a,o)!==!1)&&void 0!==o&&o({hasError:!1,savedData:a})})}),d!==!1&&(a.update=O=function(o,a){var r,i=void 0===m?void 0:m.check({data:o,isExceptUndefined:!0});void 0!==i&&i.checkHasError()===!0?void 0!==a&&a({hasError:!0,errors:i.getErrors()}):(r=function(){k.updateData(o,function(r,i){void 0!==r?void 0!==a&&a({hasError:!0,errorMsg:r}):(void 0!==i&&(void 0!==e.afterUpdate&&e.afterUpdate(i),t.ROOMS(b+"/"+o.id).broadcast({methodName:"update",data:i})),void 0!==a&&a({hasError:!1,savedData:i}))})},void 0!==e.beforeUpdate?e.beforeUpdate(o,{ret:a,proc:r})!==!1&&r():r())}),c!==!1&&(a.remove=A=function(o,a){var r;r=function(){k.removeData(o,function(o,r){void 0!==o?void 0!==a&&a({hasError:!0,errorMsg:o}):(void 0!==r&&(void 0!==e.afterRemove&&e.afterRemove(r),t.ROOMS(b+"/"+r.id).broadcast({methodName:"remove",data:r}),EACH(p,function(o){var e=r[o];t.ROOMS(b+"/"+o+"/"+e+"/remove").broadcast({methodName:"remove",data:r})})),void 0!==a&&a({hasError:!1,savedData:r}))})},void 0!==e.beforeRemove?e.beforeRemove(o,{ret:a,proc:r})!==!1&&r():r()}),v!==!1&&(a.findData=_=function(t,o){void 0!==t&&void 0===o&&(o=t,t=void 0),k.findData(t,function(t,a){void 0!==t?void 0!==o&&o({hasError:!0,errorMsg:t}):(void 0===e.findData||e.findData(a,o)!==!1)&&void 0!==o&&o({hasError:!1,savedData:a})})}),s!==!1&&(a.findDataSet=C=function(t,o){void 0!==t&&void 0===o&&(o=t,t=void 0),k.findDataSet(t,function(t,a){void 0!==t?void 0!==o&&o({hasError:!0,errorMsg:t}):(void 0===e.findDataSet||e.findDataSet(a,o)!==!1)&&void 0!==o&&o({hasError:!1,savedDataSet:a})})}),u!==!1&&(a.countDataSet=g=function(t,o){void 0!==t&&void 0===o&&(o=t,t=void 0),k.countDataSet(t,function(t,a){void 0!==t?void 0!==o&&o({hasError:!0,errorMsg:t}):(void 0===e.countDataSet||e.countDataSet(a,o)!==!1)&&void 0!==o&&o({hasError:!1,count:a})})}),f!==!1&&(a.checkIsExists=N=function(t,o){void 0!==t&&void 0===o&&(o=t,t=void 0),k.checkIsExists(t,function(t,a){void 0!==t?void 0!==o&&o({hasError:!0,errorMsg:t}):(void 0===e.checkIsExists||e.checkIsExists(a,o)!==!1)&&void 0!==o&&o({hasError:!1,isExists:a})})}),e.getName=M=function(){return b}}})})}),FOR_BOX(function(t){"use strict";t.MODULE=METHOD({run:function(o,e){var a=__dirname+"/../..";return require(a+"/"+t.boxName+"/SERVER/node_modules/"+e)}})}),FOR_BOX(function(t){"use strict";t.ROOM=METHOD({run:function(o,e,a){CONNS.addRoomFunc(t.boxName+"/"+e,function(t,o,e,r,i,n,d,c,v,s){var u=OBJECT({init:function(a,i,u){var f,E,m,D,h,l,S,R,O,A,_,C,g,N,M={};u.on=f=function(e,a){var r,i=t+"/"+e;r=function(t){var e=CHECK_IS_DATA(t.data)===!0?UNPACK_DATA(t.data):t.data,r=t.instantListenerName;a(e,function(t){o.emit(r,CHECK_IS_DATA(t)===!0?PACK_DATA(t):t)})},o.addListener(i,r),void 0===M[i]&&(M[i]=[]),M[i].push(r)},u.broadcast=E=function(o){var e=o.methodName,a=CHECK_IS_DATA(o.data)===!0?PACK_DATA(o.data):o.data,r=t+"/"+e;CONNS.emitToAllWorkers({fullURI:t,listenerName:r,data:a})},u.broadcastExceptSender=m=function(e){var a=e.methodName,r=CHECK_IS_DATA(e.data)===!0?PACK_DATA(e.data):e.data,i=t+"/"+a;o.broadcast.to(t).emit(i,r),CONNS.broadcastToAllWorkers({methodName:"emitToAllSockets",data:{fullURI:t,listenerName:i,data:r}})},u.removeAllListeners=D=function(){EACH(M,function(t,e){EACH(t,function(t){o.removeListener(e,t)})}),M.length=0},u.setAuthKey=h=function(t){n(t)},u.getAuthKey=l=function(){return d()},u.removeAuthKey=S=function(){c()},u.addRole=R=function(t){v[t]=!0},u.checkRole=O=function(t){return v[t]===!0},u.removeRole=A=function(t){REMOVE_AT({data:v,key:t})},u.removeAllRoles=_=function(){EACH(v,function(t,o){REMOVE_AT({data:v,key:o})})},u.addDisconnectListener=C=function(t){s.push(t)},u.getIp=g=function(){return e},u.getHeaders=N=function(){return r}}});return void 0!==a&&a(u,i),u})}})}),FOR_BOX(function(t){"use strict";t.ROOMS=CLASS({init:function(o,e,a,r){var i,n=t.boxName+"/"+r;a.broadcast=i=function(t){var o=t.methodName,e=CHECK_IS_DATA(t.data)===!0?PACK_DATA(t.data):t.data,a=n+"/"+o;CONNS.type.socketPack["in"](n).emit(a,e)}}})}),global.SERVER_CONFIG=SERVER_CONFIG={dbName:"UPPERCASE_IO-testdb",dbUsername:"test",dbPassword:"test",isNotRequiringDBAuth:!1,maxDataCount:1e3,securedUsername:"test",securedPassword:"test"},global.TIME_SYNC=TIME_SYNC=OBJECT({init:function(){"use strict";UPPERCASE.IO.ROOM("timeSync",function(t){t.on("sync",function(t,o){var e=new Date,a=t.now;o({diff:a-e})})})}});