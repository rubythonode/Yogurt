global.CONNECT_TO_DB_SERVER=CONNECT_TO_DB_SERVER=METHOD({run:function(o,t,i){"use strict";var n=t.username,e=t.password,r=void 0===t.host?"127.0.0.1":t.host,d=void 0===t.port?27017:t.port,E=t.name;require("mongodb").MongoClient.connect("mongodb://"+(void 0!==n&&void 0!==e?n+":"+e+"@":"")+r+":"+d+"/"+E,function(t,n){t!==TO_DELETE?console.log("[UPPERCASE.IO-DB] CONNECT TO DB SERVER FAILED:",t):(o.nativeDB=n,i())})}}),FOR_BOX(function(o){"use strict";o.DB=CLASS({init:function(t,i,n,e){var r,d,E,a,c,_,v,u,f=require("mongodb").ObjectID,s=CONNECT_TO_DB_SERVER.nativeDB,D=s.collection(o.boxName+"."+e),O=s.collection(o.boxName+"."+e+"__BACKUP"),T=s.collection(o.boxName+"."+e+"__ERROR"),m=function(o){return new f(o)},A=function(o){return void 0!==o._id&&(o.id=o._id.toString()),delete o._id,delete o.__IS_ENABLED,delete o.__RANDOM_KEY,o},g=function(o){EACH(o,function(t,i){t===TO_DELETE?REMOVE_AT({data:o,key:i}):(CHECK_IS_DATA(t)===!0||CHECK_IS_ARRAY(t)===!0)&&g(t)})},C=function(o){var t=function(o){void 0!==o.id&&(CHECK_IS_DATA(o.id)===!0?(EACH(o.id,function(t,i){CHECK_IS_DATA(t)===!0||CHECK_IS_ARRAY(t)===!0?EACH(t,function(o,i){t[i]=m(o)}):o.id[i]=m(t)}),o._id=o.id):o._id=m(id),delete o.id),o.__IS_ENABLED=!0,EACH(o,function(t,i){void 0===t&&delete o[i]})};void 0!==o.$and?EACH(o.$and,function(o){t(o)}):void 0!==o.$or?EACH(o.$or,function(o){t(o)}):t(o)},l=function(o){var t=o.method,i=o.data,n=new Date,e={method:t,time:n,data:i};O.save(e,function(){}),NODE_CONFIG.isDBLogMode===!0&&console.log("[UPPERCASE.IO-DB] DATA SAVED:",e)},N=function(o){o.time=new Date,T.save(o,function(){}),console.log("[UPPERCASE.IO-DB] ERROR:",o)};n.create=r=function(o,t){var i;try{o.__IS_ENABLED=!0,o.__RANDOM_KEY=Math.random(),o.createTime=new Date,g(o),D.save(o,function(n,e){n===TO_DELETE?(l({method:"create",data:e}),A(e),void 0!==t&&t(void 0,e)):(i=n.toString(),N({method:"create",data:o,errorMsg:i}),void 0!==t&&t(i))})}catch(n){i=n.toString(),N({method:"create",data:o,errorMsg:i}),void 0!==t&&t(i)}},d=function(o,t){var i,n=o.filter,e=o.sort;try{C(n),D.find(n).sort(e).limit(1).toArray(function(n,e){var r;n===TO_DELETE?(e!==TO_DELETE&&e.length>0&&(r=e[0],A(r)),t(void 0,r)):(i=n.toString(),N({method:"get",params:o,errorMsg:i}),t(i))})}catch(r){i=r.toString(),N({method:"get",params:o,errorMsg:i}),t(i)}},n.get=E=function(o,t){var i,n,e,r;void 0!==o&&void 0===t&&(t=o,o=void 0),CHECK_IS_DATA(o)===!0?(i=o.filter,n=o.sort,e=o.isRandom):i=void 0!==o?{_id:m(o)}:{},void 0===i&&(i={}),void 0===n&&(n={createTime:-1}),e===!0?(i.__RANDOM_KEY={$gte:r=Math.random()},n.__RANDOM_KEY=1,d({filter:i,sort:n},function(o,e){void 0===o&&void 0===e?(i.__RANDOM_KEY={$lte:r},d({filter:i,sort:n},t)):t(o,e)})):d({filter:i,sort:n},t)},n.update=a=function(o,t){var i,n,e=o.id,r=o.$inc;try{i={_id:m(e),__IS_ENABLED:!0},NEXT([function(o){D.findOne(i,o)},function(i){return function(e,d){e===TO_DELETE?d===TO_DELETE?void 0!==t&&t():(EACH(o,function(o,t){"id"!==t&&"_id"!==t&&"__IS_ENABLED"!==t&&"createTime"!==t&&"$inc"!==t&&(d[t]=o)}),g(d),d.lastUpdateTime=new Date,void 0!==r?D.save(d,function(o){i(d,o)}):D.save(d,function(o){i.next(d,o)})):(n=e.toString(),N({method:"update",data:o,errorMsg:n}),void 0!==t&&t(n))}},function(o){return function(t){D.update(i,{$inc:r},function(i){EACH(r,function(o,i){t[i]+=o}),o(t,i)})}},function(){return function(i,e){e===TO_DELETE?(l({method:"update",data:i}),A(i),void 0!==t&&t(void 0,i)):(n=e.toString(),N({method:"update",data:o,errorMsg:n}),void 0!==t&&t(n))}}])}catch(d){n=d.toString(),N({method:"update",data:o,errorMsg:n}),void 0!==t&&t(n)}},n.remove=c=function(o,t){var i,n;try{i={_id:m(o),__IS_ENABLED:!0},D.findOne(i,function(i,e){i===TO_DELETE?e===TO_DELETE?void 0!==t&&t():(e.__IS_ENABLED=!1,e.removeTime=new Date,D.save(e,function(i){i===TO_DELETE?(l({method:"remove",data:e}),A(e),void 0!==t&&t(void 0,e)):(n=i.toString(),N({method:"remove",id:o,errorMsg:n}),void 0!==t&&t(n))})):(n=i.toString(),N({method:"remove",id:o,errorMsg:n}),void 0!==t&&t(n))})}catch(e){n=e.toString(),N({method:"remove",id:o,errorMsg:n}),void 0!==t&&t(n)}},n.find=_=function(o,t){var i,n,e=void 0===o?void 0:o.filter,r=void 0===o?void 0:o.sort,d=void 0===o?void 0:o.start,E=void 0===o||void 0===o.count?void 0:INTEGER(o.count),a=void 0===o||void 0===o.isFindAll?void 0:INTEGER(o.isFindAll);void 0!==o&&void 0===t&&(t=o);try{void 0===e&&(e={}),void 0===r&&(r={createTime:-1}),void 0===d&&(d=0),a!==!0&&(void 0===E||E>NODE_CONFIG.maxDataCount||isNaN(E)===!0?E=NODE_CONFIG.maxDataCount:1>E&&(E=1)),C(e),n=function(n,e){n===TO_DELETE?(e!==TO_DELETE&&EACH(e,function(o){A(o)}),t(void 0,e)):(i=n.toString(),N({method:"find",params:o,errorMsg:i}),t(i))},a===!0?D.find(e).sort(r).skip(d).toArray(n):D.find(e).sort(r).skip(d).limit(E).toArray(n)}catch(c){i=c.toString(),N({method:"find",params:o,errorMsg:i}),t(i)}},n.count=v=function(o,t){var i;void 0!==o&&void 0===t&&(t=o),void 0===o&&(o={});try{C(o),D.find(o).count(function(n,e){n===TO_DELETE?t(void 0,e):(i=n.toString(),N({method:"count",filter:o,errorMsg:i}),t(i))})}catch(n){i=n.toString(),N({method:"count",filter:o,errorMsg:i}),t(i)}},n.checkIsExists=u=function(o,t){var i;void 0!==o&&void 0===t&&(t=o),void 0===o?o={}:CHECK_IS_DATA(o)!==!0&&(o={_id:m(o)});try{C(o),D.find(o).count(function(n,e){n===TO_DELETE?t(void 0,void 0!==e&&e>0):(i=n.toString(),N({method:"checkIsExists",filter:o,errorMsg:i}),t(i))})}catch(n){i=n.toString(),N({method:"checkIsExists",filter:o,errorMsg:i}),t(i)}}}})}),FOR_BOX(function(o){"use strict";o.LOG_DB=CLASS({init:function(t,i,n,e){var r,d=CONNECT_TO_DB_SERVER.nativeDB,E=d.collection(o.boxName+"."+e);n.log=r=function(o){o.time=new Date,E.save(o,function(){})}}})}),OVERRIDE(NODE_CONFIG,function(o){global.NODE_CONFIG=NODE_CONFIG=COMBINE_DATA({origin:o,extend:{isDBLogMode:!1,maxDataCount:1e3}})});