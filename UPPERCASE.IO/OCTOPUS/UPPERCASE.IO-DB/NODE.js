global.CONNECT_TO_DB_SERVER=CONNECT_TO_DB_SERVER=METHOD(function(t){var o,i;return t.getNativeDB=i=function(){return o},{run:function(t,i){"use strict";var n=t.username,e=t.password,r=void 0===t.host?"127.0.0.1":t.host,d=void 0===t.port?27017:t.port,E=t.name;require("mongodb").MongoClient.connect("mongodb://"+(void 0!==n&&void 0!==e?n+":"+e+"@":"")+r+":"+d+"/"+E,function(t,n){t!==TO_DELETE?console.log("[UPPERCASE.IO-DB] CONNECT TO DB SERVER FAILED:",t):(o=n,i())})}}}),FOR_BOX(function(t){"use strict";t.DB=CLASS({init:function(o,i,n){var e,r,d,E,a,c,_,v,u=require("mongodb").ObjectID,f=CONNECT_TO_DB_SERVER.getNativeDB(),s=f.collection(t.boxName+"."+n),D=f.collection(t.boxName+"."+n+"__BACKUP"),O=f.collection(t.boxName+"."+n+"__ERROR"),T=function(t){return new u(t)},m=function(t){return void 0!==t._id&&(t.id=t._id.toString()),delete t._id,delete t.__IS_ENABLED,delete t.__RANDOM_KEY,t},g=function(t){EACH(t,function(o,i){o===TO_DELETE?REMOVE_AT({data:t,key:i}):(CHECK_IS_DATA(o)===!0||CHECK_IS_ARRAY(o)===!0)&&g(o)})},A=function(t){var o=function(t){void 0!==t.id&&(CHECK_IS_DATA(t.id)===!0?(EACH(t.id,function(o,i){CHECK_IS_DATA(o)===!0||CHECK_IS_ARRAY(o)===!0?EACH(o,function(t,i){o[i]=T(t)}):t.id[i]=T(o)}),t._id=t.id):t._id=T(id),delete t.id),t.__IS_ENABLED=!0,EACH(t,function(o,i){void 0===o&&delete t[i]})};void 0!==t.$and?EACH(t.$and,function(t){o(t)}):void 0!==t.$or?EACH(t.$or,function(t){o(t)}):o(t)},C=function(t){var o=t.method,i=t.data,n=new Date,e={method:o,time:n,data:i};D.save(e,function(){}),NODE_CONFIG.isDBLogMode===!0&&console.log("[UPPERCASE.IO-DB] DATA SAVED:",e)},N=function(t){t.time=new Date,O.save(t,function(){}),console.log("[UPPERCASE.IO-DB] ERROR:",t)};i.create=e=function(t,o){var i;try{t.__IS_ENABLED=!0,t.__RANDOM_KEY=Math.random(),t.createTime=new Date,g(t),s.save(t,function(n,e){n===TO_DELETE?(C({method:"create",data:e}),m(e),void 0!==o&&o(void 0,e)):(i=n.toString(),N({method:"create",data:t,errorMsg:i}),void 0!==o&&o(i))})}catch(n){i=n.toString(),N({method:"create",data:t,errorMsg:i}),void 0!==o&&o(i)}},r=function(t,o){var i,n=t.filter,e=t.sort;try{A(n),s.find(n).sort(e).limit(1).toArray(function(n,e){var r;n===TO_DELETE?(e!==TO_DELETE&&e.length>0&&(r=e[0],m(r)),o(void 0,r)):(i=n.toString(),N({method:"get",params:t,errorMsg:i}),o(i))})}catch(r){i=r.toString(),N({method:"get",params:t,errorMsg:i}),o(i)}},i.get=d=function(t,o){var i,n,e,d;void 0!==t&&void 0===o&&(o=t,t=void 0),CHECK_IS_DATA(t)===!0?(i=t.filter,n=t.sort,e=t.isRandom):i=void 0!==t?{_id:T(t)}:{},void 0===i&&(i={}),void 0===n&&(n={createTime:-1}),e===!0?(i.__RANDOM_KEY={$gte:d=Math.random()},n.__RANDOM_KEY=1,r({filter:i,sort:n},function(t,e){void 0===t&&void 0===e?(i.__RANDOM_KEY={$lte:d},r({filter:i,sort:n},o)):o(t,e)})):r({filter:i,sort:n},o)},i.update=E=function(t,o){var i,n,e=t.id,r=t.$inc;try{i={_id:T(e),__IS_ENABLED:!0},NEXT([function(t){s.findOne(i,t)},function(i){return function(e,d){e===TO_DELETE?d===TO_DELETE?void 0!==o&&o():(EACH(t,function(t,o){"id"!==o&&"_id"!==o&&"__IS_ENABLED"!==o&&"createTime"!==o&&"$inc"!==o&&(d[o]=t)}),g(d),d.lastUpdateTime=new Date,void 0!==r?s.save(d,function(t){i(d,t)}):s.save(d,function(t){i.next(d,t)})):(n=e.toString(),N({method:"update",data:t,errorMsg:n}),void 0!==o&&o(n))}},function(t){return function(o){s.update(i,{$inc:r},function(i){EACH(r,function(t,i){o[i]+=t}),t(o,i)})}},function(){return function(i,e){e===TO_DELETE?(C({method:"update",data:i}),m(i),void 0!==o&&o(void 0,i)):(n=e.toString(),N({method:"update",data:t,errorMsg:n}),void 0!==o&&o(n))}}])}catch(d){n=d.toString(),N({method:"update",data:t,errorMsg:n}),void 0!==o&&o(n)}},i.remove=a=function(t,o){var i,n;try{i={_id:T(t),__IS_ENABLED:!0},s.findOne(i,function(i,e){i===TO_DELETE?e===TO_DELETE?void 0!==o&&o():(e.__IS_ENABLED=!1,e.removeTime=new Date,s.save(e,function(i){i===TO_DELETE?(C({method:"remove",data:e}),m(e),void 0!==o&&o(void 0,e)):(n=i.toString(),N({method:"remove",id:t,errorMsg:n}),void 0!==o&&o(n))})):(n=i.toString(),N({method:"remove",id:t,errorMsg:n}),void 0!==o&&o(n))})}catch(e){n=e.toString(),N({method:"remove",id:t,errorMsg:n}),void 0!==o&&o(n)}},i.find=c=function(t,o){var i,n,e=void 0===t?void 0:t.filter,r=void 0===t?void 0:t.sort,d=void 0===t?void 0:t.start,E=void 0===t||void 0===t.count?void 0:INTEGER(t.count),a=void 0===t||void 0===t.isFindAll?void 0:INTEGER(t.isFindAll);void 0!==t&&void 0===o&&(o=t);try{void 0===e&&(e={}),void 0===r&&(r={createTime:-1}),void 0===d&&(d=0),a!==!0&&(void 0===E||E>NODE_CONFIG.maxDataCount||isNaN(E)===!0?E=NODE_CONFIG.maxDataCount:1>E&&(E=1)),A(e),n=function(n,e){n===TO_DELETE?(e!==TO_DELETE&&EACH(e,function(t){m(t)}),o(void 0,e)):(i=n.toString(),N({method:"find",params:t,errorMsg:i}),o(i))},a===!0?s.find(e).sort(r).skip(d).toArray(n):s.find(e).sort(r).skip(d).limit(E).toArray(n)}catch(c){i=c.toString(),N({method:"find",params:t,errorMsg:i}),o(i)}},i.count=_=function(t,o){var i;void 0!==t&&void 0===o&&(o=t),void 0===t&&(t={});try{A(t),s.find(t).count(function(n,e){n===TO_DELETE?o(void 0,e):(i=n.toString(),N({method:"count",filter:t,errorMsg:i}),o(i))})}catch(n){i=n.toString(),N({method:"count",filter:t,errorMsg:i}),o(i)}},i.checkIsExists=v=function(t,o){var i;void 0!==t&&void 0===o&&(o=t),void 0===t?t={}:CHECK_IS_DATA(t)!==!0&&(t={_id:T(t)});try{A(t),s.find(t).count(function(n,e){n===TO_DELETE?o(void 0,void 0!==e&&e>0):(i=n.toString(),N({method:"checkIsExists",filter:t,errorMsg:i}),o(i))})}catch(n){i=n.toString(),N({method:"checkIsExists",filter:t,errorMsg:i}),o(i)}}}})}),FOR_BOX(function(t){"use strict";t.LOG_DB=CLASS({init:function(o,i,n){var e,r=CONNECT_TO_DB_SERVER.getNativeDB(),d=r.collection(t.boxName+"."+n);i.log=e=function(t){t.time=new Date,d.save(t,function(){})}}})}),OVERRIDE(NODE_CONFIG,function(t){global.NODE_CONFIG=NODE_CONFIG=COMBINE_DATA({origin:t,extend:{isDBLogMode:!1,maxDataCount:1e3}})});