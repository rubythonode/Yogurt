global.BOOT=function(params){"use strict";var fs=require("fs"),path=require("path"),OTHER_LANGS=params.OTHER_LANGS,rootPath=__dirname+"/..",browserScript="\nglobal = window;\n",securedBrowserScript="\nglobal = window;\n",css="",securedCSS="",logoText,pageContent="",loadAll,generatePageContent,startServer;loadAll=function(){var checkIsAllowedFolder,initBoxes,loadForServer,loadForBrowser,loadForBrowserSecured,load,scanFolders,loadFoldersForServer,loadFoldersForBrowser,loadFoldersForBrowserSecured,loadFolders,overrideConfig,loadDB,minify,loadLogoText;checkIsAllowedFolder=function(params){var path=params.path,name=params.name;return fs.statSync(rootPath+"/"+path).isDirectory()===true&&name[0]!=="."&&name!=="node_modules"&&name!=="not_load"&&name!=="deprecated"&&name[0]!=="_"};initBoxes=function(){fs.readdirSync(rootPath).forEach(function(boxName){if(checkIsAllowedFolder({path:boxName,name:boxName})===true){global[boxName]=BOX(boxName);browserScript+="global."+boxName+" = BOX('"+boxName+"');\n";securedBrowserScript+="global."+boxName+" = BOX('"+boxName+"');\n"}})};loadForServer=function(relativePath){var absolutePath=rootPath+"/"+relativePath,extname=path.extname(relativePath),extension;if(extname===".js"){require(absolutePath)}for(extension in OTHER_LANGS){if(OTHER_LANGS.hasOwnProperty(extension)===true){if(extname==="."+extension){require(absolutePath)}}}};loadForBrowser=function(relativePath){var absolutePath=rootPath+"/"+relativePath,extname=path.extname(relativePath),content=fs.readFileSync(absolutePath).toString(),extension;if(extname===".js"){browserScript+=content+"\n";securedBrowserScript+=content+"\n"}else if(extname===".css"){css+=content;securedCSS+=content}for(extension in OTHER_LANGS){if(OTHER_LANGS.hasOwnProperty(extension)===true){if(extname==="."+extension){browserScript+=OTHER_LANGS[extension](content)+"\n";securedBrowserScript+=OTHER_LANGS[extension](content)+"\n"}}}};loadForBrowserSecured=function(relativePath){var absolutePath=rootPath+"/"+relativePath,extname=path.extname(relativePath),content=fs.readFileSync(absolutePath).toString(),extension;if(extname===".js"){securedBrowserScript+=content+"\n"}else if(extname===".css"){securedCSS+=content+"\n"}for(extension in OTHER_LANGS){if(OTHER_LANGS.hasOwnProperty(extension)===true){if(extname==="."+extension){securedBrowserScript+=OTHER_LANGS[extension](content)+"\n"}}}};load=function(relativePath){loadForServer(relativePath);loadForBrowser(relativePath)};scanFolders=function(folderName,func){var scanFolder=function(path){var folderPaths,i;if(fs.existsSync(path)===true){folderPaths=[];fs.readdirSync(path).forEach(function(name){var fullPath=path+"/"+name;if(checkIsAllowedFolder({path:fullPath,name:name})===true){folderPaths.push(fullPath)}else if(fs.statSync(rootPath+"/"+fullPath).isDirectory()!==true){func(fullPath)}});for(i=0;i<folderPaths.length;i+=1){scanFolder(folderPaths[i])}}};FOR_BOX(function(box){scanFolder(box.boxName+"/"+folderName)})};loadFoldersForServer=function(folderName){scanFolders(folderName,loadForServer)};loadFoldersForBrowser=function(folderName){scanFolders(folderName,loadForBrowser)};loadFoldersForBrowserSecured=function(folderName){scanFolders(folderName,loadForBrowserSecured)};loadFolders=function(folderName){scanFolders(folderName,load)};overrideConfig=function(){if(params!==undefined){if(params.CONFIG!==undefined){EXTEND_DATA({origin:global.CONFIG,extend:params.CONFIG});browserScript+="EXTEND_DATA({ origin : global.CONFIG, extend : "+JSON.stringify(params.CONFIG,null,2)+" });\n";securedBrowserScript+="EXTEND_DATA({ origin : global.CONFIG, extend : "+JSON.stringify(params.CONFIG,null,2)+" });\n"}if(params.SERVER_CONFIG!==undefined){EXTEND_DATA({origin:global.SERVER_CONFIG,extend:params.SERVER_CONFIG});SERVER_CONFIG.rootPath=rootPath}if(params.BROWSER_CONFIG!==undefined){browserScript+="EXTEND_DATA({ origin : global.BROWSER_CONFIG, extend : "+JSON.stringify(params.BROWSER_CONFIG,null,2)+" });\n";securedBrowserScript+="EXTEND_DATA({ origin : global.BROWSER_CONFIG, extend : "+JSON.stringify(params.BROWSER_CONFIG,null,2)+" });\n"}}CONFIG.version=String((new Date).getTime());browserScript+="CONFIG.version = "+CONFIG.version+";\n";securedBrowserScript+="CONFIG.version = "+CONFIG.version+";\n"};loadDB=function(){var Mongolian=UPPERCASE.MODULE("mongolian");UPPERCASE.db=(new Mongolian).db(SERVER_CONFIG.dbName);if(SERVER_CONFIG.isNotNeedDBAuth!==true){UPPERCASE.db.auth(SERVER_CONFIG.dbUsername,SERVER_CONFIG.dbPassword)}};minify=function(){var uglifyJS=UPPERCASE.MODULE("uglify-js"),sqwish=UPPERCASE.MODULE("sqwish");browserScript=uglifyJS.parse(browserScript).print_to_string();securedBrowserScript=uglifyJS.parse(securedBrowserScript).print_to_string();css=sqwish.minify(css);securedCSS=sqwish.minify(securedCSS)};loadLogoText=function(){logoText=fs.readFileSync(rootPath+"/UPPERCASE/LOGO");browserScript="/* Welcome to JavaScript World! :)\n"+logoText+"\n  Contact: "+CONFIG.contactAddress+"\n\n*/"+browserScript;css="/* Welcome to CSS World! :)\n"+logoText+"\n  Contact: "+CONFIG.contactAddress+"\n\n*/"+css};load("UPPERCASE/METHOD.js");load("UPPERCASE/CLASS.js");load("UPPERCASE/OBJECT.js");load("UPPERCASE/BOX.js");initBoxes();load("UPPERCASE/FOR_BOX.js");loadFolders("COMMON");loadFoldersForServer("SERVER");loadFoldersForBrowser("BROWSER");loadFoldersForBrowserSecured("BROWSER_SECURED");loadForBrowser("UPPERCASE/BROWSER_FIX.js");overrideConfig();if(SERVER_CONFIG.isNotUsingDB!==true){loadDB()}loadForBrowser("UPPERCASE/BROWSER_INIT.js");if(CONFIG.isDevMode!==true){minify()}loadLogoText()};generatePageContent=function(){pageContent+="<!DOCTYPE html>";pageContent+="<!--\n\n  Welcome! :)\n"+logoText+"\n  Contact: "+CONFIG.contactAddress+"\n\n-->";pageContent+="<html>";pageContent+="<head>";pageContent+='<meta charset="utf-8">';pageContent+='<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">';pageContent+='<meta name="google" value="notranslate">';if(CONFIG.googleSiteVerificationKey!==undefined){pageContent+='<meta name="google-site-verification" content="'+CONFIG.googleSiteVerificationKey+'" />'}pageContent+="<title>"+CONFIG.defaultTitle+"</title>";pageContent+='<link rel="stylesheet" type="text/css" href="__CSS?'+CONFIG.version+'" />';pageContent+="</head>";pageContent+="<body>";pageContent+="<noscript>";pageContent+='<p style="padding:15px;">';pageContent+="자바스크립트 기능이 꺼져있습니다. 브라우저의 자바스크립트 기능을 켜 주시기 바랍니다. 감사합니다~! ^-^";pageContent+="<br>";pageContent+="JavaScript is disabled. Please enable JavaScript in your browser. Thank you~! :)";pageContent+="</p>";pageContent+="</noscript>";pageContent+='<script type="text/javascript" src="__SCRIPT?'+CONFIG.version+'"></script>';pageContent+="</body>";pageContent+="</html>"};startServer=function(){var http=require("http"),https=require("https"),socketIO=UPPERCASE.MODULE("socket.io"),IncomingForm=UPPERCASE.MODULE("formidable").IncomingForm,imagemagick=UPPERCASE.MODULE("imagemagick"),server,securedServer,io,serve;serve=function(req,res){var url=req.url,uri,version,isSecured,boxName,folderName,responseCache={},getContentTypeFromURI,getEncodingFromContentType,separateVersion,separateURI,separateBoxName,separateFolderName,checkIsAuthed,checkIsCached,redirect,responseNeedAuth,responseCached,response,serveFavicon,serveAuth,serveIndex,serveBrowserScript,serveCSS,serveUpload,serveResource,serveResourceFinal,serveErrorPage;getContentTypeFromURI=function(uri){var extname=path.extname(uri);if(extname===".png"){return"image/png"}if(extname===".jpg"||extname===".jpeg"){return"image/jpeg"}if(extname===".gif"){return"image/gif"}if(extname===".js"){return"text/javascript"}if(extname===".css"){return"text/css"}if(extname===".txt"){return"text/plain"}if(extname===".html"){return"text/html"}if(extname===".swf"){return"application/x-shockwave-flash"}return"application/octet-stream"};getEncodingFromContentType=function(contentType){if(contentType==="text/javascript"){return"utf-8"}if(contentType==="text/css"){return"utf-8"}if(contentType==="text/plain"){return"binary"}if(contentType==="text/html"){return"utf-8"}if(contentType==="image/png"){return"binary"}if(contentType==="image/jpeg"){return"binary"}if(contentType==="image/gif"){return"binary"}if(contentType==="application/x-shockwave-flash"){return"binary"}return"binary"};separateVersion=function(){var i=url.indexOf("?");if(i!==-1){version=url.substring(i+1);url=url.substring(0,i)}};separateURI=function(){uri=url.substring(1)};separateBoxName=function(){var i=uri.indexOf("/");if(i===-1){boxName=CONFIG.defaultBoxName}else{boxName=uri.substring(0,i);uri=uri.substring(i+1)}};separateFolderName=function(){var i=uri.indexOf("/");if(i===-1){folderName=""}else{folderName=uri.substring(0,i);uri=uri.substring(i+1)}};checkIsAuthed=function(){var sps;if(req.headers.authorization===undefined){return false}sps=new Buffer(req.headers.authorization.split(" ")[1],"base64").toString().split(":");console.log("Decoded authorization: "+sps);return sps[0]===SERVER_CONFIG.securedUsername&&sps[1]===SERVER_CONFIG.securedPassword};checkIsCached=function(key){return key===undefined?req.headers["if-none-match"]!==undefined:req.headers["if-none-match"]===key};redirect=function(url){res.writeHead(302,{Location:url});res.end()};responseNeedAuth=function(){console.log("Someone is trying to AUTH!: "+req.connection.remoteAddress);res.statusCode=401;res.setHeader("WWW-Authenticate",'Basic realm="AUTH"');res.end()};responseCached=function(){res.statusCode=304;res.end()};response=function(params){var key=params.key,content=params.content,contentType=params.contentType,encoding=params.encoding;res.setHeader("Content-Type",contentType);if(key!==undefined){res.setHeader("ETag",key)}res.statusCode=200;res.end(content,encoding)};serveFavicon=function(){redirect("/"+CONFIG.defaultBoxName+"/R/favicon.ico")};serveAuth=function(){if(req.headers.authorization===undefined){responseNeedAuth();return}if(checkIsAuthed()===true){redirect(SERVER_CONFIG.authedPageUrl);return}redirect("/UPPERCASE/R/AUTH_ERROR.html");return};serveIndex=function(){response({content:pageContent,contentType:"text/html",encoding:"utf-8"})};serveBrowserScript=function(){if(checkIsCached(CONFIG.version)===true&&CONFIG.isDevMode!==true){responseCached()}else if(version!==CONFIG.version&&CONFIG.isDevMode!==true){redirect(url+"?"+CONFIG.version)}else if(checkIsAuthed()===true){response({key:CONFIG.version,content:securedBrowserScript,contentType:"text/javascript",encoding:"utf-8"})}else{response({key:CONFIG.version,content:browserScript,contentType:"text/javascript",encoding:"utf-8"})}};serveCSS=function(){if(checkIsCached(CONFIG.version)===true&&CONFIG.isDevMode!==true){responseCached()}else if(version!==CONFIG.version&&CONFIG.isDevMode!==true){redirect(url+"?"+CONFIG.version)}else if(checkIsAuthed()===true){response({key:CONFIG.version,content:securedCSS,contentType:"text/css",encoding:"utf-8"})}else{response({key:CONFIG.version,content:css,contentType:"text/css",encoding:"utf-8"})}};serveUpload=function(){var form=new IncomingForm,fileDatas=[],fieldData={};form.uploadDir="__RF/"+boxName+"/__TEMP/";if(fs.existsSync(rootPath+"/"+form.uploadDir)===false){console.log("Not exists folder: "+rootPath+"/"+form.uploadDir)}if(global[boxName]!==undefined&&fs.existsSync(rootPath+"/"+form.uploadDir)===true){form.on("field",function(fieldName,value){fieldData[fieldName]=value}).on("file",function(fieldName,file){fileDatas.push({tempPath:file.path,size:file.size,name:file.name,type:file.type,lastModifiedDate:file.lastModifiedDate})}).on("end",function(){var uploadFileDB=global[boxName].DB("__UPLOAD_FILE"),uploadedCount=0;EACH(fileDatas,function(fileData,i){var tempPath=fileData.tempPath;if(fileData.size>CONFIG.maxUploadFileMB*1024*1024){res.writeHead(200,{"Content-Type":"text/html"});res.end("<script>errorCode='SIZE'</script>","utf-8");return false}EACH(fieldData,function(value,name){if(value.trim()!==""){fileData[name]=value}});REMOVE_AT({data:fileData,key:"tempPath"});imagemagick.readMetadata(tempPath,function(error,metadata){var f=function(){uploadFileDB.createData(fileData,function(errorMsg,savedData){var mv=UPPERCASE.MODULE("mv"),tergetPath=rootPath+"/__RF/"+boxName+"/"+savedData.id;if(errorMsg===undefined){mv(tempPath,tergetPath,function(){uploadedCount+=1;if(uploadedCount===fileDatas.length){EACH(fileDatas,function(fileData,i){fileDatas[i]=PACK_DATA(fileData)});res.writeHead(200,{"Content-Type":"text/html"});res.end("<script>fileDatas="+JSON.stringify(fileDatas)+"</script>","utf-8")}console.log("File '"+tergetPath+"' ("+savedData.name+", "+savedData.size+" byte) uploaded.")})}})};if(metadata.exif!==undefined){fileData.exif=metadata.exif;imagemagick.convert([tempPath,"-auto-orient",tempPath],function(error){f()})}else{f()}})})}).on("error",function(error){res.writeHead(200,{"Content-Type":"text/html"});res.end("<script>errorCode='ERROR'</script>","utf-8")});form.parse(req)}else{res.writeHead(200,{"Content-Type":"text/html"});res.end("<script>errorCode='ERROR'</script>","utf-8")}};serveResource=function(){var fullPath,contentType,encoding;if(checkIsCached(CONFIG.version)===true){responseCached()}else if(version!==CONFIG.version){redirect(url+"?"+CONFIG.version)}else{fullPath=rootPath+"/"+boxName+"/R/"+uri;if(responseCache[fullPath]!==undefined){response(responseCache[fullPath])}else{contentType=getContentTypeFromURI(uri);encoding=getEncodingFromContentType(contentType);fs.exists(fullPath,function(exists){if(exists===true){fs.readFile(fullPath,encoding,function(error,content){if(error!==null){serveErrorPage()}else{response(responseCache[fullPath]={key:CONFIG.version,content:content,contentType:contentType,encoding:encoding})}})}else{serveErrorPage()}})}}};serveResourceFinal=function(){var fullPath;if(checkIsCached()===true){responseCached()}else{fullPath=rootPath+"/__RF/"+boxName+"/"+uri;fs.exists(fullPath,function(exists){if(exists===true){fs.readFile(fullPath,"binary",function(error,content){if(error!==null){serveErrorPage()}else{fs.stat(fullPath,function(error,stat){if(error!==null){serveErrorPage()}else{response({key:stat.size+"-"+Date.parse(stat.mtime),content:content,contentType:"application/octet-stream",encoding:"binary"})}})}})}else{serveErrorPage()}})}};serveErrorPage=function(){redirect(SERVER_CONFIG.errorPageUrl)};separateVersion();separateURI();if(uri==="favicon.ico"){serveFavicon()}else if(uri==="__AUTH"){serveAuth()}else if(uri===""){serveIndex()}else if(uri==="__SCRIPT"){serveBrowserScript()}else if(uri==="__CSS"){serveCSS()}else{separateBoxName();separateFolderName();if(folderName==="R"){serveResource(boxName)}else if(folderName==="RF"){serveResourceFinal(boxName)}else if(uri==="__UPLOAD"&&req.method.toUpperCase()==="POST"){serveUpload()}else{serveErrorPage()}}};server=http.createServer(serve).listen(CONFIG.port);if(SERVER_CONFIG.securedPort!==undefined){securedServer=https.createServer({key:fs.readFileSync(rootPath+"/"+SERVER_CONFIG.securedKeyFileName),cert:fs.readFileSync(rootPath+"/"+SERVER_CONFIG.securedCrtFileName)},serve).listen(SERVER_CONFIG.securedPort)}io=socketIO.listen(server);if(CONFIG.isDevMode===true){io.set("log level",2)}else{io.set("log level",1)}io.set("transports",["websocket","flashsocket","xhr-polling","jsonp-polling"]);CONNS.type.socketPack=io.sockets;OBJECT.init();FOR_BOX(function(box){if(box.MAIN!==undefined){box.MAIN()}});console.log("[UPPERCASE SERVER STARTED] http://localhost:"+CONFIG.port+(SERVER_CONFIG.securedPort!==undefined?" and secured server started. https://localhost:"+SERVER_CONFIG.securedPort:""))};loadAll();generatePageContent();startServer()};