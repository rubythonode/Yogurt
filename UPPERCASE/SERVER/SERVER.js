global.CONNS=OBJECT({init:function(cls,inner,self){"use strict";var socketPack=cls.socketPack,roomFuncs={},addRoomFunc;self.addRoomFunc=addRoomFunc=function(name,func){if(roomFuncs[name]===undefined){roomFuncs[name]=[]}roomFuncs[name].push(func)};socketPack.on("connection",function(socket){var ip=socket.handshake.headers["x-forwarded-for"],rooms={},roomCounts={},authKey,roles={},disconnectListeners={};if(ip===undefined){ip=socket.handshake.address.address}socket.addListener("disconnect",function(){EACH(disconnectListeners,function(disconnectListeners){EACH(disconnectListeners,function(disconnectListener){disconnectListener()})})});socket.addListener("__ENTER_ROOM",function(fullURI){EACH(roomFuncs,function(roomFuncs,name){var uri="",tempName=name,params={},getParam;getParam=function(subURI){var paramName,tempName2;if(tempName.indexOf("{")!==-1&&tempName.indexOf("}")!==-1){tempName2=tempName.substring(0,tempName.indexOf("{"));if(uri+"/"===tempName2){paramName=tempName.substring(tempName.indexOf("{")+1,tempName.indexOf("}"));tempName=tempName2+subURI+tempName.substring(tempName.indexOf("}")+1);return{name:paramName,value:subURI}}}};EACH(fullURI.split("/"),function(subURI,i){var param=getParam(subURI);if(param!==undefined){params[param.name]=param.value}if(i===0){uri=subURI}else{uri+="/"+subURI}if(uri===tempName){return false}});if(fullURI===tempName){if(roomCounts[fullURI]===undefined){rooms[fullURI]=[];disconnectListeners[fullURI]=[];socket.join(fullURI);EACH(roomFuncs,function(roomFunc,i){rooms[fullURI].push(roomFunc(fullURI,socket,ip,socket.handshake.headers,params,function(_authKey){authKey=_authKey},function(){return authKey},function(){authKey=undefined},roles,disconnectListeners[fullURI]))});roomCounts[fullURI]=1}else{roomCounts[fullURI]+=1}return false}})});socket.addListener("__EXIT_ROOM",function(fullURI){roomCounts[fullURI]-=1;if(roomCounts[fullURI]===0){EACH(rooms[fullURI],function(room){room.removeAllListeners()});socket.leave(fullURI);delete rooms[fullURI];delete roomCounts[fullURI];delete disconnectListeners[fullURI]}})})}});FOR_BOX(function(box){"use strict";box.DB=CLASS({init:function(cls,inner,self,name){var ObjectId=UPPERCASE.MODULE("mongolian").ObjectId,collection=UPPERCASE.db.collection(box.boxName+"."+name),backupCollection=UPPERCASE.db.collection(box.boxName+"."+name+"_backup"),errorLogCollection=UPPERCASE.db.collection(box.boxName+"."+name+"_error"),gen_id,cleanData,removeToDeleteParams,makeUpFilter,backup,logError,createData,createDataSafely,getData,updateData,updateDataSafely,removeData,removeDataSafely,findData,findDatas,countDatas,checkIsExists;gen_id=function(id){return new ObjectId(id)};cleanData=function(data){if(data._id!==undefined){data.id=data._id.toString()}delete data._id;delete data._isEnable;return data};removeToDeleteParams=function(data){EACH(data,function(value,key){if(value===TO_DELETE){REMOVE_AT({data:data,key:key})}else if(CHECK_IS_DATA(value)===true||CHECK_IS_ARRAY(value)===true){removeToDeleteParams(value)}})};makeUpFilter=function(filter){if(filter.id!==undefined){if(CHECK_IS_DATA(filter.id)===true){EACH(filter.id,function(values,i){if(CHECK_IS_DATA(values)===true||CHECK_IS_ARRAY(values)===true){EACH(values,function(value,j){values[j]=gen_id(value)})}else{filter.id[i]=gen_id(values)}});filter._id=filter.id}else{filter._id=gen_id(id)}delete filter.id}filter._isEnable=true;EACH(filter,function(value,name){if(value===undefined){delete filter[name]}})};backup=function(params){var call=params.call,data=params.data,now=new Date;backupCollection.save({call:call,time:now,data:data})};logError=function(data){data.time=new Date;errorLogCollection.save(data)};self.createData=createData=function(data,callback){var errorMsg,f;try{data._isEnable=true;data.createTime=new Date;removeToDeleteParams(data);collection.save(data);backup({method:"createData",data:data});if(callback!==undefined){cleanData(data);callback({isSucceed:true,savedData:data})}}catch(error){errorMsg=error.toString();logError({method:"createData",data:data,errorMsg:errorMsg});if(callback!==undefined){callback({isSucceed:false,errorMsg:errorMsg})}}};self.createDataSafely=createDataSafely=function(data,callback){var errorMsg,f;try{data._isEnable=true;data.createTime=new Date;removeToDeleteParams(data);collection.save(data,function(error,savedData){if(error===null){backup({method:"createDataSafely",data:savedData});cleanData(savedData);callback({isSucceed:true,savedData:savedData})}else{errorMsg=error.toString();logError({method:"createDataSafely",data:data,errorMsg:errorMsg});callback({isSucceed:false,errorMsg:errorMsg})}})}catch(error){errorMsg=error.toString();logError({method:"createDataSafely",data:data,errorMsg:errorMsg});callback({isSucceed:false,errorMsg:errorMsg})}};self.getData=getData=function(id,callback){var filter,errorMsg;try{filter={_id:gen_id(id),_isEnable:true};collection.findOne(filter,function(error,savedData){if(error===null){if(savedData!==undefined){cleanData(savedData)}callback({isSucceed:true,savedData:savedData})}else{errorMsg=error.toString();logError({method:"getData",id:id,errorMsg:errorMsg});callback({isSucceed:false,errorMsg:errorMsg})}})}catch(error){errorMsg=error.toString();logError({method:"getData",id:id,errorMsg:errorMsg});callback({isSucceed:false,errorMsg:errorMsg})}};self.updateData=updateData=function(data,callback){var id=data.id,filter,errorMsg;try{filter={_id:gen_id(id),_isEnable:true};collection.findOne(filter,function(error,savedData){var f;delete data.id;if(error===null){if(savedData===undefined){if(callback!==undefined){callback({isSucceed:true,savedData:undefined})}}else{EACH(savedData,function(value,name){if(data[name]===undefined||name==="_id"||name==="_isEnable"||name==="createTime"){data[name]=value}});removeToDeleteParams(data);data.lastUpdateTime=new Date;collection.save(data);backup({method:"updateData",data:data});if(callback!==undefined){cleanData(data);callback({isSucceed:true,savedData:data})}}}else{errorMsg=error.toString();logError({method:"updateData",data:data,errorMsg:errorMsg});if(callback!==undefined){callback({isSucceed:false,errorMsg:errorMsg})}}})}catch(error){errorMsg=error.toString();logError({method:"updateData",data:data,errorMsg:errorMsg});if(callback!==undefined){callback({isSucceed:false,errorMsg:errorMsg})}}};self.updateDataSafely=updateDataSafely=function(data,callback){var id=data.id,filter,errorMsg;try{filter={_id:gen_id(id),_isEnable:true};collection.findOne(filter,function(error,savedData){var f;delete data.id;if(error===null){if(savedData===undefined){callback({isSucceed:true,savedData:undefined})}else{EACH(savedData,function(value,name){if(data[name]===undefined||name==="_id"||name==="_isEnable"||name==="createTime"){data[name]=value}});removeToDeleteParams(data);data.lastUpdateTime=new Date;collection.save(data,function(error,savedData){if(error===null){backup({method:"updateDataSafely",data:savedData});cleanData(savedData);callback({isSucceed:true,savedData:savedData})}else{errorMsg=error.toString();logError({method:"updateDataSafely",data:data,errorMsg:errorMsg});callback({isSucceed:false,errorMsg:errorMsg})}})}}else{errorMsg=error.toString();logError({method:"updateDataSafely",data:data,errorMsg:errorMsg});callback({isSucceed:false,errorMsg:errorMsg})}})}catch(error){errorMsg=error.toString();logError({method:"updateDataSafely",data:data,errorMsg:errorMsg});callback({isSucceed:false,errorMsg:errorMsg})}};self.removeData=removeData=function(id,callback){var filter,errorMsg;try{filter={_id:gen_id(id),_isEnable:true};collection.findOne(filter,function(error,savedData){var f;if(error===null){if(savedData===undefined){if(callback!==undefined){callback({isSucceed:true,savedData:undefined})}}else{savedData._isEnable=false;savedData.removeTime=new Date;collection.save(savedData);backup({method:"removeData",data:savedData});if(callback!==undefined){cleanData(savedData);callback({isSucceed:true,savedData:savedData})}}}else{errorMsg=error.toString();logError({method:"removeData",id:id,errorMsg:errorMsg});if(callback!==undefined){callback({isSucceed:false,errorMsg:errorMsg})}}})}catch(error){errorMsg=error.toString();logError({method:"removeData",id:id,errorMsg:errorMsg});if(callback!==undefined){callback({isSucceed:false,errorMsg:errorMsg})}}};self.removeDataSafely=removeDataSafely=function(id,callback){var filter,errorMsg;try{filter={_id:gen_id(id),_isEnable:true};collection.findOne(filter,function(error,savedData){var f;if(error===null){if(savedData===undefined){callback({isSucceed:true,savedData:undefined})}else{savedData._isEnable=false;savedData.removeTime=new Date;collection.save(savedData,function(error,savedData){if(error===null){backup({method:"removeDataSafely",data:savedData});cleanData(savedData);callback({isSucceed:true,savedData:savedData})}else{errorMsg=error.toString();logError({method:"removeDataSafely",id:id,errorMsg:errorMsg});callback({isSucceed:false,errorMsg:errorMsg})}})}}else{errorMsg=error.toString();logError({method:"removeDataSafely",id:id,errorMsg:errorMsg});callback({isSucceed:false,errorMsg:errorMsg})}})}catch(error){errorMsg=error.toString();logError({method:"removeDataSafely",id:id,errorMsg:errorMsg});callback({isSucceed:false,errorMsg:errorMsg})}};self.findData=findData=function(filter,callback){var errorMsg;if(filter!==undefined&&callback===undefined){callback=filter}if(filter===undefined){filter={}}try{makeUpFilter(filter);collection.findOne(filter,function(error,savedData){if(error===null){if(savedData!==undefined){cleanData(savedData)}callback({isSucceed:true,savedData:savedData})}else{errorMsg=error.toString();logError({method:"findData",filter:filter,errorMsg:errorMsg});callback({isSucceed:false,errorMsg:errorMsg})}})}catch(error){errorMsg=error.toString();logError({method:"findData",filter:filter,errorMsg:errorMsg});callback({isSucceed:false,errorMsg:errorMsg})}};self.findDatas=findDatas=function(params,callback){var filter=params===undefined?undefined:params.filter,sort=params===undefined?undefined:params.sort,start=params===undefined?undefined:params.start,count=params===undefined||params.count===undefined?undefined:parseInt(params.count,10),isFindAll=params===undefined||params.isFindAll===undefined?undefined:parseInt(params.isFindAll,10),errorMsg,proc;if(params!==undefined&&callback===undefined){callback=params}try{if(filter===undefined){filter={}}if(sort===undefined){sort={}}if(start===undefined){start=0}if(isFindAll!==true){if(count===undefined||count>SERVER_CONFIG.maxDataCount||isNaN(count)===true){count=SERVER_CONFIG.maxDataCount}else if(count<1){count=1}}makeUpFilter(filter);proc=function(error,savedDatas){if(error===null){if(savedDatas!==undefined){EACH(savedDatas,function(savedData,i){cleanData(savedData)})}callback({isSucceed:true,savedDatas:savedDatas})}else{errorMsg=error.toString();logError({method:"findDatas",params:params,errorMsg:errorMsg});callback({isSucceed:false,errorMsg:errorMsg})}};if(isFindAll===true){collection.find(filter).sort(sort).skip(start).toArray(proc)}else{collection.find(filter).sort(sort).skip(start).limit(count).toArray(proc)}}catch(error){errorMsg=error.toString();logError({method:"findDatas",params:params,errorMsg:errorMsg});callback({isSucceed:false,errorMsg:errorMsg})}};self.countDatas=countDatas=function(filter,callback){var errorMsg;if(filter!==undefined&&callback===undefined){callback=filter}if(filter===undefined){filter={}}try{makeUpFilter(filter);collection.find(filter).count(function(error,count){if(error===null){callback({isSucceed:true,count:count})}else{errorMsg=error.toString();logError({method:"countDatas",filter:filter,errorMsg:errorMsg});callback({isSucceed:false,errorMsg:errorMsg})}})}catch(error){errorMsg=error.toString();logError({method:"countDatas",filter:filter,errorMsg:errorMsg});callback({isSucceed:false,errorMsg:errorMsg})}};self.checkIsExists=checkIsExists=function(filter,callback){var errorMsg;if(filter!==undefined&&callback===undefined){callback=filter}if(filter===undefined){filter={}}try{makeUpFilter(filter);collection.find(filter).count(function(error,count){if(error===null){callback({isSucceed:true,isExists:count!==undefined&&count>0})}else{errorMsg=error.toString();logError({method:"checkIsExists",filter:filter,errorMsg:errorMsg});callback({isSucceed:false,errorMsg:errorMsg})}})}catch(error){errorMsg=error.toString();logError({method:"checkIsExists",filter:filter,errorMsg:errorMsg});callback({isSucceed:false,errorMsg:errorMsg})}}}})});FOR_BOX(function(box){"use strict";box.LOG_DB=CLASS({init:function(cls,inner,self,name){var collection=UPPERCASE.db.collection(box.boxName+"."+name),log;self.log=log=function(data){data.time=new Date;collection.save(data)}}})});FOR_BOX(function(box){"use strict";OVERRIDE({origin:box.MODEL,func:function(origin){box.MODEL=CLASS({init:function(cls,inner,self,params){var name=params.name,propertyNamesForNewEvent=params.propertyNamesForNewEvent===undefined?[]:params.propertyNamesForNewEvent,config=params.config,createConfig,getDataConfig,updateConfig,removeConfig,findDataConfig,findDatasConfig,countDatasConfig,checkIsExistsConfig,createValid,updateValid,db=box.DB(name),getCreateValid,getUpdateValid,getDB,create,getData,update,remove,findData,findDatas,countDatas,checkIsExists;if(config!==undefined){createConfig=config.create;getDataConfig=config.getData;updateConfig=config.update;removeConfig=config.remove;findDataConfig=config.findData;findDatasConfig=config.findDatas;countDatasConfig=config.countDatas;checkIsExistsConfig=config.checkIsExists;if(createConfig!==undefined){createValid=createConfig.valid}if(updateConfig!==undefined){updateValid=updateConfig.valid}}inner.getCreateValid=getCreateValid=function(){return createValid};inner.getUpdateValid=getUpdateValid=function(){return updateValid};box.ROOM(name+"/create");EACH(propertyNamesForNewEvent,function(propertyName){box.ROOM(name+"/"+propertyName+"/{value}/create")});box.ROOM(name,function(room){if(createConfig!==false){room.on("create",function(data,ret){var validResult=createValid.check({data:data}),proc;if(validResult.checkHasError()===true){ret({hasError:true,errors:validResult.getErrors()})}else{proc=function(){db.createDataSafely(data,function(result){var isSucceed=result.isSucceed,errorMsg=result.errorMsg,savedData=result.savedData;if(isSucceed===false){ret({hasError:true,errorMsg:errorMsg})}else{if(inner.afterCreate!==undefined){inner.afterCreate(savedData)}if(inner.afterCreateRoom!==undefined){inner.afterCreateRoom({savedData:savedData,room:room})}box.ROOMS(name+"/create").broadcast({methodName:"create",data:savedData});EACH(propertyNamesForNewEvent,function(propertyName){var value=savedData[propertyName];if(value!==undefined){box.ROOMS(name+"/"+propertyName+"/"+value+"/create").broadcast({methodName:"create",data:savedData})}});ret({hasError:false,savedData:savedData})}})};if(inner.beforeCreateRoom===undefined){if(inner.beforeCreate!==undefined){if(inner.beforeCreate(data,{ret:ret,proc:proc})!==false){proc()}}else{proc()}}else{inner.beforeCreateRoom({data:data,room:room},{ret:ret,proc:proc})}}})}if(getDataConfig!==false){room.on("getData",getData)}if(findDataConfig!==false){room.on("findData",findData)}if(findDatasConfig!==false){room.on("findDatas",function(params,ret){delete params.isFindAll;findDatas(params,ret)})}if(countDatasConfig!==false){room.on("countDatas",countDatas)}if(checkIsExistsConfig!==false){room.on("checkIsExists",checkIsExists)}});box.ROOM(name+"/{id}",function(room,params){var id=params.id;if(updateConfig!==false){room.on("update",function(data,ret){var validResult=updateValid.check({data:data,isExceptUndefined:true}),proc;data.id=id;if(validResult.checkHasError()===true){ret({hasError:true,errors:validResult.getErrors()})}else{proc=function(){db.updateDataSafely(data,function(result){var isSucceed=result.isSucceed,errorMsg=result.errorMsg,savedData=result.savedData;if(isSucceed===false){ret({hasError:true,errorMsg:errorMsg})}else{if(inner.afterUpdate!==undefined){inner.afterUpdate(savedData)}if(inner.afterUpdateRoom!==undefined){inner.afterUpdateRoom({savedData:savedData,room:room})}room.broadcast({methodName:"update",data:savedData});ret({hasError:false,savedData:savedData})}})};if(inner.beforeUpdateRoom===undefined){if(inner.beforeUpdate!==undefined){if(inner.beforeUpdate(data,{ret:ret,proc:proc})!==false){proc()}}else{proc()}}else{if(inner.beforeUpdateRoom({data:data,room:room},{ret:ret,proc:proc})!==false){proc()}}}})}if(removeConfig!==false){room.on("remove",function(id,ret){var proc;proc=function(){db.removeDataSafely(id,function(result){var isSucceed=result.isSucceed,errorMsg=result.errorMsg,savedData=result.savedData;if(isSucceed===false){ret({hasError:true,errorMsg:errorMsg})}else{if(inner.afterRemove!==undefined){inner.afterRemove(savedData)}if(inner.afterRemoveRoom!==undefined){inner.afterRemoveRoom({savedData:savedData,room:room})}room.broadcast({methodName:"remove",data:savedData});ret({hasError:false,savedData:savedData})}})};if(inner.beforeRemoveRoom===undefined){if(inner.beforeRemove!==undefined){if(inner.beforeRemove(id,{ret:ret,proc:proc})!==false){proc()}}else{proc()}}else{if(inner.beforeRemoveRoom({id:id,room:room},{ret:ret,proc:proc})!==false){proc()}}})}});inner.getDB=getDB=function(){return db};if(createConfig!==false){self.create=create=function(data,ret){var validResult=createValid.check({data:data}),proc;if(validResult.checkHasError()===true){if(ret!==undefined){ret({hasError:true,errors:validResult.getErrors()})}}else{proc=function(){db.createDataSafely(data,function(result){var isSucceed=result.isSucceed,errorMsg=result.errorMsg,savedData=result.savedData;if(isSucceed===false){if(ret!==undefined){ret({hasError:true,errorMsg:errorMsg})}}else{if(inner.afterCreate!==undefined){inner.afterCreate(savedData)}box.ROOMS(name+"/create").broadcast({methodName:"create",data:savedData});EACH(propertyNamesForNewEvent,function(propertyName){var value=savedData[propertyName];if(value!==undefined){box.ROOMS(name+"/"+propertyName+"/"+value+"/create").broadcast({methodName:"create",data:savedData})}});if(ret!==undefined){ret({hasError:false,savedData:savedData})}}})};if(inner.beforeCreate!==undefined){if(inner.beforeCreate(data,{ret:ret,proc:proc})!==false){proc()}}else{proc()}}}}if(getDataConfig!==false){self.getData=getData=function(id,ret){db.getData(id,function(result){var isSucceed=result.isSucceed,errorMsg=result.errorMsg,savedData=result.savedData;if(isSucceed===false){if(ret!==undefined){ret({hasError:true,errorMsg:errorMsg})}}else{if(inner.getData===undefined||inner.getData(savedData,ret)!==false){if(ret!==undefined){ret({hasError:false,savedData:savedData})}}}})}}if(updateConfig!==false){self.update=update=function(data,ret){var validResult=updateValid.check({data:data,isExceptUndefined:true}),proc;if(validResult.checkHasError()===true){if(ret!==undefined){ret({hasError:true,errors:validResult.getErrors()})}}else{proc=function(){db.updateDataSafely(data,function(result){var isSucceed=result.isSucceed,errorMsg=result.errorMsg,savedData=result.savedData;if(isSucceed===false){if(ret!==undefined){ret({hasError:true,errorMsg:errorMsg})}}else{if(inner.afterUpdate!==undefined){inner.afterUpdate(savedData)}box.ROOMS(name+"/"+data.id).broadcast({methodName:"update",data:savedData});if(ret!==undefined){ret({hasError:false,savedData:savedData})}}})};if(inner.beforeUpdate!==undefined){if(inner.beforeUpdate(data,{ret:ret,proc:proc})!==false){proc()}}else{proc()}}}}if(removeConfig!==false){self.remove=remove=function(id,ret){var proc;proc=function(){db.removeDataSafely(id,function(result){var isSucceed=result.isSucceed,errorMsg=result.errorMsg,savedData=result.savedData;if(isSucceed===false){if(ret!==undefined){ret({hasError:true,errorMsg:errorMsg})}}else{if(inner.afterRemove!==undefined){inner.afterRemove(savedData)}if(savedData!==undefined){box.ROOMS(name+"/"+savedData.id).broadcast({methodName:"remove",data:savedData})}if(ret!==undefined){ret({hasError:false,savedData:savedData})}}})};if(inner.beforeRemove!==undefined){if(inner.beforeRemove(id,{ret:ret,proc:proc})!==false){proc()}}else{proc()}}}if(findDataConfig!==false){self.findData=findData=function(filter,ret){db.findData(filter,function(result){var isSucceed=result.isSucceed,errorMsg=result.errorMsg,savedData=result.savedData;if(isSucceed===false){if(ret!==undefined){ret({hasError:true,errorMsg:errorMsg})}}else{if(inner.findData===undefined||inner.findData(savedData,ret)!==false){if(ret!==undefined){ret({hasError:false,savedData:savedData})}}}})}}if(findDatasConfig!==false){self.findDatas=findDatas=function(params,ret){db.findDatas(params,function(result){var isSucceed=result.isSucceed,errorMsg=result.errorMsg,savedDatas=result.savedDatas;if(isSucceed===false){if(ret!==undefined){ret({hasError:true,errorMsg:errorMsg})}}else{if(inner.findDatas===undefined||inner.findDatas(savedDatas,ret)!==false){if(ret!==undefined){ret({hasError:false,savedDatas:savedDatas})}}}})}}if(countDatasConfig!==false){self.countDatas=countDatas=function(filter,ret){db.countDatas(filter,function(result){var isSucceed=result.isSucceed,errorMsg=result.errorMsg,count=result.count;if(isSucceed===false){if(ret!==undefined){ret({hasError:true,errorMsg:errorMsg})}}else{if(inner.countDatas===undefined||inner.countDatas(count,ret)!==false){if(ret!==undefined){ret({hasError:false,count:count})}}}})}}if(checkIsExistsConfig!==false){self.checkIsExists=checkIsExists=function(filter,ret){db.checkIsExists(filter,function(result){var isSucceed=result.isSucceed,errorMsg=result.errorMsg,isExists=result.isExists;if(isSucceed===false){if(ret!==undefined){ret({hasError:true,errorMsg:errorMsg})}}else{if(inner.checkIsExists===undefined||inner.checkIsExists(isExists,ret)!==false){if(ret!==undefined){ret({hasError:false,isExists:isExists})}}}})}}}})}})});FOR_BOX(function(box){"use strict";box.MODULE=METHOD({run:function(m,name){var root=__dirname+"/../..";return require(root+"/"+box.boxName+"/SERVER/node_modules/"+name)}})});FOR_BOX(function(box){"use strict";box.ROOM=METHOD({run:function(m,name,func){CONNS.addRoomFunc(box.boxName+"/"+name,function(fullURI,socket,ip,headers,params,_setAuthKey,_getAuthKey,_removeAuthKey,roles,disconnectListeners){var object=OBJECT({init:function(cls,inner,self){var listeners={},on,broadcast,broadcastExceptSender,removeAllListeners,setAuthKey,getAuthKey,removeAuthKey,addRole,checkRole,removeRole,removeAllRoles,addDisconnectListener,getIp,getHeaders;self.on=on=function(methodName,callback){var listenerName=fullURI+"/"+methodName,func;func=function(params){var data=CHECK_IS_DATA(params.data)===true?UNPACK_DATA(params.data):params.data,instantListenerName=params.instantListenerName;callback(data,function(result){socket.emit(instantListenerName,CHECK_IS_DATA(result)===true?PACK_DATA(result):result)})};socket.addListener(listenerName,func);if(listeners[listenerName]===undefined){listeners[listenerName]=[]}listeners[listenerName].push(func)};self.broadcast=broadcast=function(params){var methodName=params.methodName,data=CHECK_IS_DATA(params.data)===true?PACK_DATA(params.data):params.data,listenerName=fullURI+"/"+methodName;CONNS.type.socketPack["in"](fullURI).emit(listenerName,data)};self.broadcastExceptSender=broadcastExceptSender=function(params){var methodName=params.methodName,data=CHECK_IS_DATA(params.data)===true?PACK_DATA(params.data):params.data,listenerName=fullURI+"/"+methodName;socket.broadcast.to(fullURI).emit(listenerName,data)};self.removeAllListeners=removeAllListeners=function(){EACH(listeners,function(funcs,listenerName){EACH(funcs,function(func){socket.removeListener(listenerName,func)})});listeners.length=0};self.setAuthKey=setAuthKey=function(authKey){_setAuthKey(authKey)};self.getAuthKey=getAuthKey=function(){return _getAuthKey()};self.removeAuthKey=removeAuthKey=function(){_removeAuthKey()};self.addRole=addRole=function(role){roles[role]=true};self.checkRole=checkRole=function(role){return roles[role]===true};self.removeRole=removeRole=function(role){REMOVE_AT({data:roles,key:role})};self.removeAllRoles=removeAllRoles=function(){EACH(roles,function(v,role){REMOVE_AT({data:roles,key:role})})};self.addDisconnectListener=addDisconnectListener=function(disconnectListener){disconnectListeners.push(disconnectListener)};self.getIp=getIp=function(){return ip};self.getHeaders=getHeaders=function(){return headers}}});if(func!==undefined){func(object,params)}return object})}})});FOR_BOX(function(box){"use strict";box.ROOMS=CLASS({init:function(cls,inner,self,name,func){var ns=box.boxName+"/"+name,broadcast;self.broadcast=broadcast=function(params){var methodName=params.methodName,data=CHECK_IS_DATA(params.data)===true?PACK_DATA(params.data):params.data,listenerName=ns+"/"+methodName;CONNS.type.socketPack["in"](ns).emit(listenerName,data)}}})});global.SERVER_CONFIG={dbName:"UPPERCASE-testdb",dbUsername:"test",dbPassword:"test",isNotNeedDbAuth:false,maxDataCount:1e3,securedUsername:"test",securedPassword:"test",authedPageUrl:"/UPPERCASE/R/AUTHED.html",errorPageUrl:"/UPPERCASE/R/ERROR.html"};global.SHA1=METHOD({run:function(m,params){"use strict";var key=params.key,password=params.password,crypto=require("crypto");return crypto.createHmac("sha1",key).update(password).digest("hex")}});global.TIME_SYNC=OBJECT({init:function(){"use strict";UPPERCASE.ROOM("timeSync",function(room){room.on("sync",function(data,ret){var now=new Date,clientNow=data.now;ret({diff:clientNow-now})})})}});